# https://sequencediagram.org/

title Purchase in foreign sales channel via TVM

actor "Traveller" as traveller
participant "TVM" as foreignSales
participant "Token Issuer\n(Token API)" as tokenIssuer
participant "Home Sales Channel (with Wallet)\n(Traveller API)" as homeSales


traveller<--foreignSales: Offers to purchase ticket
traveller->foreignSales: Presents travel card for purchase

foreignSales->tokenIssuer: Query for PSP\n""GET /api/v1/token/{thumbprint}/psp""
foreignSales<--tokenIssuer: PID of PSP
foreignSales->homeSales: Wallet query\n""GET /api/v1/token/{thumbprint}/wallet""
foreignSales<--homeSales: Payment means and limits

traveller<--foreignSales: Payment means and limits
traveller->foreignSales: Selects payment means

opt payment mean require card present proof
foreignSales->homeSales: Wallet transaction (reserve amount)\n""GET /api/v1/token/{thumbprint}/challenge""
foreignSales<--homeSales: Challenge

foreignSales<->traveller: Request signature\nof challenge
end

foreignSales->homeSales: Wallet transaction (reserve amount)\n""POST /api/v1/token/{thumbprint}/wallet/transaction""
foreignSales<--homeSales: OK/Not OK

box over foreignSales: TVM buys ticket as ticket vendor

foreignSales->homeSales: Wallet transaction (finalise)\n""PATCH /api/v1/token/{thumbprint}/wallet/transaction/{transaction}""
foreignSales<--homeSales: OK

traveller<--foreignSales: Purchase completed
foreignSales-->tokenIssuer: Register hint
